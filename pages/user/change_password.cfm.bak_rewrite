<!--- /pages/user/change_password.cfm --->
<cfprocessingdirective pageencoding="utf-8">
<cfcontent type="text/html; charset=UTF-8">

<cfif NOT structKeyExists(session, "userid")>
  <cflocation url="login.cfm" addtoken="false">
</cfif>

<cfset msg = "">
<cfset ok  = false>

<cfif structKeyExists(form, "currentPassword") AND structKeyExists(form, "newPassword")>
  <cfobject component="components.UserService" name="userService">
  <cftry>
    <!-- Get the user's email from profile (since session.userName is FullName, not Email) -->
    <cfset prof = userService.getProfile(session.userID)>
    <cfset userEmail = (isQuery(prof) AND prof.recordCount) ? toString(prof.Email[1]) : "">

    <cfif NOT len(trim(userEmail))>
      <cfset msg = "❌ Could not load your email. Please sign in again.">
    <cfelseif form.newPassword NEQ form.confirmPassword>
      <cfset msg = "❌ New password and confirm password do not match.">
    <cfelse>
      <!-- Verify current password using email -->
      <cfset check = userService.loginUser(email=userEmail, password=form.currentPassword)>

      <cfif check.recordCount EQ 0>
        <cfset msg = "❌ Current password is incorrect.">
      <cfelse>
        <!-- Update password -->
        <cfquery datasource="laundryservice">
          UPDATE Users
          SET PasswordHash = <cfqueryparam value="#hash(form.newPassword,'SHA-256')#" cfsqltype="cf_sql_varchar">
          WHERE UserID = <cfqueryparam value="#session.userID#" cfsqltype="cf_sql_integer">
        </cfquery>

        <cfset msg = "✅ Password updated successfully.">
        <cfset ok = true>
      </cfif>
    </cfif>

    <cfcatch>
      <cfset msg = "❌ Error: #cfcatch.message#">
    </cfcatch>
  </cftry>
</cfif>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Change Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body{ font-family:Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .container{ max-width:400px; margin:40px auto; background:#fff; padding:20px;
                border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08);}
    h2{ margin-top:0; color:#5b5ee1; }
    label{ display:block; margin-top:12px; font-size:14px; color:#444; }
    input{ width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    .btn{ margin-top:16px; width:100%; padding:12px; background:#5b5ee1; color:#fff;
          font-weight:bold; border:none; border-radius:8px; cursor:pointer; }
    .msg{ margin-top:15px; font-size:14px; }
    .ok{ color:green; }
    .err{ color:red; }
    .back{ display:block; margin-top:15px; text-align:center; color:#5b5ee1; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>🔑 Change Password</h2>

    <cfif len(msg)>
      <div class="msg <cfoutput>#ok ? 'ok' : 'err'#</cfoutput>"><cfoutput>#encodeForHTML(msg)#</cfoutput></div>
    </cfif>

    <form method="post" action="change_password.cfm">
      <label>Current Password</label>
      <input type="password" name="currentPassword" required>

      <label>New Password</label>
      <input type="password" name="newPassword" required>

      <label>Confirm Password</label>
      <input type="password" name="confirmPassword" required>

      <button type="submit" class="btn">Update Password</button>
    </form>

    <a href="profile.cfm" class="back">&larr; Back to Profile</a>
  </div>
</body>
</html>
